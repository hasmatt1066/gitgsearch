# NMDP Coach Cross-Reference System - Improvements Roadmap

**Created:** 2026-01-26
**Status:** Planning

This document captures all identified gaps, issues, and improvements needed for the system.

---

## 1. Missing Logging Infrastructure - COMPLETED

### Current State - IMPLEMENTED
- [x] Log files generated at `output/logs/[school_name]_[date].log`
- [x] `output/logs/` directory created automatically
- [x] Logging integrated into Python scripts
- [x] Both console and file output

### Requirements - ALL MET
- [x] Create `output/logs/` directory structure
- [x] Add logging to key Python scripts
- [x] Log levels: INFO, WARNING, ERROR, DEBUG
- [x] Log format: `[YYYY-MM-DD HH:MM:SS] LEVEL: Message`
- [x] Each search run produces a log file

### Implementation Tasks
- [x] Create `scripts/logger.py` - shared logging utility with:
  - `setup_logger()` - configures file and console handlers
  - `get_logger()` - returns configured logger instance
  - `log_section()` - visual section headers
  - `log_summary()` - formatted statistics output
- [x] Update `cross_reference.py` to log matching operations
- [x] Update `generate_csv.py` to log output generation
- [ ] Update `validate.py` to log validation results (optional - not critical)
- [ ] Update `normalize.py` to log normalization decisions (optional - not critical)
- [x] `output/logs/` directory created automatically by logger

---

## 2. Cache Staleness Check Not Implemented - COMPLETED

### Current State
- [x] `config.json` has `cache_staleness_days: 30`
- [x] `roster.json` files have `fetched_date` field
- [x] `scripts/cache_utils.py` now reads/compares dates
- [x] CLAUDE.md workflow updated to use cache utilities

### Requirements - ALL MET
- [x] Before using cached data, check if `fetched_date` is older than `cache_staleness_days`
- [x] If stale: prompt user to refresh or use cached data anyway
- [x] If fresh: use cached data without prompting

### Implementation Tasks
- [x] Create `scripts/cache_utils.py` with staleness checking functions:
  - `is_cache_stale(cache_path, staleness_days) -> bool`
  - `get_cache_age_days(cache_path) -> int`
  - `get_cache_status(school_name, cache_dir, staleness_days) -> dict`
  - `get_cache_completeness(school_name, cache_dir) -> dict`
  - `get_cached_coaches(school_name, cache_dir) -> list`
  - `format_cache_status(status) -> str`
- [x] Update CLAUDE.md workflow to use these utilities
- [x] Add force refresh option (documented in CLAUDE.md workflow)

---

## 3. CSV Output Schema Mismatch - COMPLETED

### Investigation Result
The `generate_csv.py` script **already matches the PRD specification**. The old CSV file that had different columns was generated by a different process or earlier version.

### Current Output (Correct)
| Column | Status |
|--------|--------|
| Coach Name | ✓ |
| Current School | ✓ (useful addition) |
| Current Position | ✓ |
| Career History (2020-Present) | ✓ |
| Source URLs (pipe-separated) | ✓ |
| NMDP Overlap (YES/NO) | ✓ |
| Overlap Details | ✓ |
| Data Quality | ✓ |

### Implementation Tasks - N/A
- [x] Verified `generate_csv.py` already produces correct schema
- [x] Regenerated Oregon CSV - output matches PRD
- No changes needed

---

## 4. Verification Agent Retry Loop Not Automated

### Current State
- CLAUDE.md describes automatic re-research after verification flags issues
- PRD specifies max 2 retries per coach
- No automated orchestration exists - requires manual intervention
- Verification agent outputs JSON with `reresearch_requests` but nothing consumes it

### Requirements
- After verification agent completes, orchestrator should:
  1. Parse verification output for `FLAG_FOR_RERESEARCH` coaches
  2. Check retry count against `max_retries_per_coach`
  3. Spawn new Career Research agents for flagged coaches
  4. Re-run verification
  5. Loop until all coaches pass or max retries exhausted

### Implementation Tasks
- [ ] Create `scripts/orchestrator.py` with retry loop logic (optional - can remain in CLAUDE.md)
- [ ] Add retry tracking to coach JSON files (`retry_count` field)
- [ ] Update CLAUDE.md with explicit retry loop instructions
- [ ] Create helper script `scripts/check_verification.py` to parse verification output

---

## 5. School Aliases Ambiguity Documentation

### Current State
`school_aliases.json` maps multiple schools to same nicknames:
- "Tigers" → Clemson, LSU, Auburn, Jackson State, Grambling State
- "Wildcats" → Kentucky, Arizona, Kansas State
- "Cougars" → Washington State, BYU, Houston
- "Cardinals" → Louisville, Ball State
- "Eagles" → Boston College, Eastern Michigan

This is technically fine (reverse lookup goes alias → canonical) but confusing.

### Requirements
- Document that nicknames are NOT unique identifiers
- The system uses canonical names as keys, so reverse lookup is unambiguous
- Add validation to warn if an alias appears under multiple schools

### Implementation Tasks
- [ ] Add comment block in `school_aliases.json` explaining the structure
- [ ] Create `scripts/validate_aliases.py` to detect duplicate aliases
- [ ] Document in CLAUDE.md that nickname-only queries may be ambiguous

---

## 6. Year Range Parsing Edge Case - COMPLETED

### Current State - FIXED
`cross_reference.py:parse_year_range()` behavior:
- `"2020-2022"` now returns `[2020, 2021, 2022]` (end year INCLUSIVE)
- `"2024-present"` returns `[2024, 2025]` (assuming current year 2026)

**Semantics (now documented):**
- The end year is the LAST SEASON COACHED, not the year they left
- "2020-2022" = 3 seasons (2020, 2021, 2022) → academic years 2020-2021, 2021-2022, 2022-2023
- "2024-present" = current position, excludes incomplete current season

### Requirements - ALL MET
- [x] Document the exact semantics of year ranges
- [x] Ensure Career Research agents use consistent year formatting
- [x] End year is INCLUSIVE (the last season coached)

### Implementation Tasks - ALL COMPLETE
- [x] Add detailed docstring to `parse_year_range()` with explicit examples
- [x] Update `career_research.md` prompt with year format guidance
- [x] Add unit tests for `parse_year_range()` edge cases (`tests/test_cross_reference.py`)
- [x] Fixed bug: changed `range(start, end)` to `range(start, end + 1)` for explicit year ranges

---

## 7. Integration Testing - COMPLETED

### Current State - IMPLEMENTED
- [x] 15 automated tests covering full pipeline
- [x] Tests use real cached data (Oregon, Colorado) as fixtures
- [x] Catches regressions in cross-reference logic

### Test Coverage
- **TestOregonIntegration** (6 tests): Full pipeline on Oregon data
  - Verifies 24 coaches processed, 8 overlaps found
  - Checks specific expected overlaps (Terry→Hawaii, etc.)
  - Verifies no false positives (Lanning has no overlap)
- **TestColoradoIntegration** (3 tests): Tests all_coaches.json format
- **TestNormalization** (2 tests): Alias resolution, no fuzzy false positives
- **TestCacheUtilities** (2 tests): Cache status checking
- **TestCSVGeneration** (2 tests): CSV output formatting

### Implementation Tasks - COMPLETE
- [x] Create `tests/test_cross_reference.py` - unit tests for year parsing
- [x] Create `tests/test_integration.py` - end-to-end tests
- [x] Uses existing cache as fixtures (no separate fixtures needed)
- [x] Run with: `python3 tests/test_integration.py`

---

## 8. CFBCrunch Integration

### Current State
- `config.json` lists `cfbcrunch` as a search source
- `career_research.md` describes CFBCrunch URL patterns
- No structured integration - agents just use general web search

### Requirements
- CFBCrunch has structured coach data: `https://cfbcrunch.com/cfb_coach_hist.php?cid=[coach_id]`
- Could provide more reliable career histories than general web search

### Implementation Tasks
- [ ] Research CFBCrunch's data availability and structure
- [ ] Update `career_research.md` with specific CFBCrunch search strategies
- [ ] Consider adding CFBCrunch URL patterns to coach output for reference
- [ ] (Future) Could build scraper if data is consistently structured

---

## 9. Error Recovery and Partial Results - COMPLETED

### Current State - IMPLEMENTED
- [x] `cache_utils.py` reports cache completeness (already built in task #2)
- [x] CLAUDE.md has detailed recovery/resume instructions
- [x] Clear workflow for resuming partial searches

### Features
- `python3 cache_utils.py "[SCHOOL]"` shows:
  - Completion percentage
  - List of missing coaches
  - Recommendation to resume
- CLAUDE.md "Resuming from Partial State" section explains:
  - How to check current state
  - How to resume with only missing coaches
  - Example resume flow
  - How to force fresh start

### Implementation Tasks - COMPLETE
- [x] Cache completeness check via `cache_utils.py` (built earlier)
- [x] Updated CLAUDE.md with detailed recovery instructions
- [x] Resume workflow documented with example

---

## 10. NFL Team Detection Enhancement

### Current State
`normalize.py:is_nfl_team()` uses hardcoded lists of:
- Team names (49ers, Bears, etc.)
- City names (Arizona, Atlanta, etc.)

### Requirements
- Current implementation works but could have false positives
- "Arizona" could match Arizona Cardinals (NFL) or University of Arizona (college)
- Logic checks for "UNIVERSITY" or "COLLEGE" to disambiguate

### Implementation Tasks
- [ ] Add unit tests for NFL detection edge cases
- [ ] Consider adding `data/nfl_teams.json` for easier maintenance
- [ ] Document known edge cases in code comments

---

## 11. Fuzzy Matching False Positives - COMPLETED

### Problem
The fuzzy matching in `normalize.py` had a threshold of 0.85 (85%), which caused false positives:
- "University of Oregon" fuzzy matched to "University of Akron" at 87%
- This caused 19 false positive overlaps instead of 6 real ones

### Solution Implemented
**Disabled fuzzy matching entirely.** Relying on explicit alias mappings is:
- Deterministic - same input always gives same output
- Auditable - can see exactly what maps to what
- No false positives - "Oregon" will never match "Akron"

### Changes Made
- [x] Changed `use_fuzzy` default from `True` to `False` in `normalize.py`
- [x] Added missing aliases to `school_aliases.json`:
  - University of Hawaii → UNIVERSITY OF HAWAII AT MANOA
  - Tulane → TULANE UNIVERSITY
  - Richmond → UNIVERSITY OF RICHMOND
  - Central Washington → CENTRAL WASHINGTON UNIVERSITY
  - Benedictine → BENEDICTINE COLLEGE

### Results
- Oregon cross-reference: 8 real overlaps (was 19 false positives with fuzzy matching)
- Hawaii aliases now correctly match A'lique Terry and Koa Ka'ai

---

## Priority Order

### High Priority (Core Functionality)
1. **Cache Staleness Check** - Prevents using outdated data
2. **Year Range Semantics** - Ensures accurate overlap detection
3. **CSV Schema Alignment** - Consistent output format

### Medium Priority (Quality & Reliability)
4. **Integration Testing** - Catch regressions
5. **Logging Infrastructure** - Debugging and audit trail
6. **Error Recovery** - Handle partial failures gracefully

### Low Priority (Polish & Enhancement)
7. **Verification Retry Automation** - Currently manual works fine
8. **School Aliases Documentation** - Clarification only
9. **CFBCrunch Integration** - Nice to have
10. **NFL Team Detection** - Current implementation is adequate

---

## Implementation Notes

### Dependencies
- Python 3.10+ (already in use)
- pytest (for testing, to be added)
- No new external dependencies required

### Backwards Compatibility
- All changes should be backwards compatible with existing cache files
- New fields in JSON should be optional with sensible defaults
- CSV format changes should be additive (new columns OK, don't remove existing)

### Testing Strategy
- Unit tests for Python scripts
- Integration tests using fixture data in `tests/fixtures/`
- Manual testing for agent prompts (inherently non-deterministic)
